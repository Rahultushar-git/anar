<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ANAR - Video Call</title>
  <style>
    body,html { margin:0; height:100%; font-family:sans-serif; background:#fafafa; }
    .app { height:100vh; display:flex; flex-direction:column; position:relative; }
    .header { background:#8557B6; color:#fff; text-align:center; padding:12px; }
    .status { text-align:center; padding:8px; background:#eee; font-size:0.9rem; }
    .video-area { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:10px; padding:10px; }
    video { width:100%; max-width:400px; aspect-ratio:1/1; background:#000; border-radius:12px; }
    .controls { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:16px; }
    .control-btn { width:56px; height:56px; border:none; border-radius:50%; font-size:22px; cursor:pointer; box-shadow:0 3px 8px rgba(0,0,0,.3); background:#fff; }
    .end-btn { background:#e63946; color:#fff; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">ANAR Video Chat</div>
    <div class="status" id="status">Connecting‚Ä¶</div>
    <div class="video-area">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay playsinline muted></video>
    </div>
    <div class="controls">
      <button class="control-btn" id="micBtn">üé§</button>
      <button class="control-btn" id="camBtn">üì∑</button>
      <button class="control-btn" id="nextBtn">‚û°Ô∏è</button>
      <button class="control-btn end-btn" id="endBtn">‚úñ</button>
    </div>
  </div>

  <script>
    const ws = new WebSocket("ws://localhost:3000"); // change to wss://your-server
    let pc, localStream;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const statusEl = document.getElementById("status");

    const micBtn = document.getElementById("micBtn");
    const camBtn = document.getElementById("camBtn");
    const endBtn = document.getElementById("endBtn");
    const nextBtn = document.getElementById("nextBtn");

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
      localVideo.srcObject = localStream;
    }

    async function createPeer() {
      pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
      pc.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify({ type:"candidate", candidate:e.candidate }));
      };
    }

    ws.onmessage = async e => {
      const msg = JSON.parse(e.data);
      if (msg.type === "waiting") {
        statusEl.textContent = "üîÑ Looking for a partner‚Ä¶";
      }
      if (msg.type === "match") {
        statusEl.textContent = "‚úÖ Connected to a stranger!";
        await initMedia();
        await createPeer();
        if (msg.initiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          ws.send(JSON.stringify({ type:"offer", offer }));
        }
      }
      if (msg.type === "offer") {
        await initMedia();
        await createPeer();
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ type:"answer", answer }));
      }
      if (msg.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
      }
      if (msg.type === "candidate") {
        try { await pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); } catch(e){}
      }
      if (msg.type === "partner-left") {
        statusEl.textContent = "‚ùå Partner disconnected. Searching‚Ä¶";
        remoteVideo.srcObject = null;
      }
    };

    // Mic toggle
    micBtn.onclick = () => {
      const t = localStream?.getAudioTracks()[0];
      if (t) { t.enabled = !t.enabled; micBtn.textContent = t.enabled ? "üé§" : "üîá"; }
    };
    // Cam toggle
    camBtn.onclick = () => {
      const t = localStream?.getVideoTracks()[0];
      if (t) { t.enabled = !t.enabled; camBtn.textContent = t.enabled ? "üì∑" : "üö´"; }
    };
    // End button
    endBtn.onclick = () => { ws.close(); pc?.close(); statusEl.textContent="Call ended"; };
    // Next button
    nextBtn.onclick = () => { ws.send(JSON.stringify({ type:"next" })); remoteVideo.srcObject=null; };
  </script>
</body>
</html>
